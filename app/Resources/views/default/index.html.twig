{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .js-menu-item-wrapper {
            box-shadow: 0 -1px 5px 0;
        }

        .js-menu-item {
            margin-bottom: 0 !important;
        }

        .js-item-card-title {
            text-align: center;
        }

        .js-item-title {
            text-align: center;
        }

        .js-document-wrapper {
            margin-bottom: 30px;
        }

        .blue {
            background-color: #DEF0F2;
        }

        .green {
            background-color: #CCDEC6;
        }

        .brown {
            background-color: #9C9E90;
        }

        .red {
            background-color: #E2B699;
        }

        .orange {
            background-color: #FBE6C7;
        }
    </style>
{% endblock %}

{% import ':default:macro.html.twig' as macros %}

{% block body %}
    <div class="js-menu">


        <div class="js-menu-item-wrapper blue">
            <h2 class="display-4 js-menu-item">docs.payments</h2>
            <div style="display:none;">


                <div class="js-menu-item-wrapper">
                    <h2 class="display-4 js-menu-item">documents</h2>
                    <div style="display:none;">
                        <p class="col-1 lead js-form-menu-item">add</p>
                        <div class="js-item card-block">
                            <div data-url="{{ path('document') }}" class="js-form-item" style="display:none;">
                                {% include ':forms:document.html.twig' %}
                            </div>
                            {% for document in documents %}
                                {{ macros.document(document) }}
                            {% endfor %}
                        </div>
                    </div>
                </div>


                <div class="js-menu-item-wrapper">
                    <h2 class="display-4 js-menu-item">payments</h2>
                    <div>
                        <p class="col-1 lead js-form-menu-item">add</p>
                        <div class="js-item card-block">
                            <div data-url="{{ path('payment') }}" class="js-form-item" style="display:none;">
                                {% include ':forms:payment.html.twig' %}
                            </div>


                            {% set total = 0 %}
                            {% set paymentStatusTitle = '' %}

                            {% for payment in paymentStatus %}

                            {% if loop.first %}
                            {% set paymentStatusTitle = payment.paymentStatus %}
                            <div class="card">
                                <p style="text-align: center;">{{ paymentStatusTitle }}</p>
                            </div>
                            <table class="col-12" border="1">
                                <tbody>
                                {% endif %}
                                {% if payment.paymentStatus != paymentStatusTitle %}
                                {% set paymentStatusTitle = payment.paymentStatus %}
                                <tr>
                                    <td><b><i>total:</i></b></td>
                                    <td>€ {{ total }}</td>
                                </tr>
                                </tbody>
                            </table>
                            {% set total = 0 %}
                            <div class="card">
                                <p style="text-align: center;">{{ paymentStatusTitle }}</p>
                            </div>

                            <table class="col-12" border="1">
                                <tbody>
                                {% endif %}
                                {% set total = total + payment.costs %}
                                {{ macros.paymentStatusList(payment) }}
                                {% endfor %}
                                <tr>
                                    <td><b><i>total:</i></b></td>
                                    <td>€{{ total }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>
        </div>


        <div class="js-menu-item-wrapper green">
            <h2 class="display-4 js-menu-item">transport</h2>
            <div style="display:none;">
                <p class="col-1 lead js-form-menu-item">add</p>
                <div class="js-item card-block">
                    <div data-url="{{ path('new', {'_object': 'Transport'}) }}" class="js-form-item" style="display:none;">
                        {% include ':forms:transport.html.twig' %}
                    </div>
                    {% for transport in transports %}
                        {{ macros.transport(transport) }}
                    {% endfor %}
                </div>
            </div>
        </div>


        <div class="js-menu-item-wrapper brown">
            <h2 class="display-4 js-menu-item">hotels</h2>
            <div style="display:none;">
                <p class="col-1 lead js-form-menu-item">add</p>
                <div class="js-item card-block">
                    <div data-url="{{ path('new', {'_object': 'Hotel'}) }}" class="js-form-item" style="display:none;">
                        {% include ':forms:hotel.html.twig' %}
                    </div>
                    {% for hotel in hotels %}
                        {{ macros.hotel(hotel) }}
                    {% endfor %}
                </div>
            </div>
        </div>


        <div class="js-menu-item-wrapper red">
            <h2 class="display-4 js-menu-item">attractions</h2>
            <div style="display:none;">
                <p class="col-1 lead js-form-menu-item">add</p>
                <div class="js-item card-block">
                    <div data-url="{{ path('new', {'_object': 'Attraction'}) }}" class="js-form-item" style="display:none;">
                        {% include ':forms:attraction.html.twig' %}
                    </div>
                    {% for attraction in attractions %}
                        {{ macros.attraction(attraction) }}
                    {% endfor %}
                </div>
            </div>
        </div>


        <div class="js-menu-item-wrapper orange">
            <h2 class="display-4 js-menu-item">itinerary</h2>
            <div>
                <div class="js-item card-block">
                    {% for item in itinerary if "now" | date('Y-m-d') <= item.startsAt | date('Y-m-d') %}
                        {{ macros.itinerary(item) }}
                    {% endfor %}
                    <div class="card card-block">
                        <h2 style="text-align: center;" class="display-4">Past</h2>
                    </div>
                    {% for item in itinerary if "now" | date('Y-m-d') > item.startsAt | date('Y-m-d') %}
                        {{ macros.itinerary(item) }}
                    {% endfor %}
                </div>
            </div>
        </div>


    </div>
{% endblock %}

    {% block javascripts %}
        {{ parent() }}
        <script>
            var EuropeTravelsApp = {
                initialize: function ($wrapper) {
                    this.$wrapper = $wrapper;

                    this.$wrapper.find('.js-menu-item').on(
                        'click',
                        this.handleMenuItemClick
                    );

                    this.$wrapper.find('.js-form-menu-item').on(
                        'click',
                        this.handleFormMenuItemClick
                    );

                    this.$wrapper.find('.js-row-title').on(
                        'click',
                        this.handleRowTitleClick
                    );

                    this.$wrapper.find('form').on(
                        'submit',
                        this.handleFormSubmit
                    );

                    this.$wrapper.find('.js-item-card-title').on(
                        'click',
                        this.handleCardTitleClick
                    );

                    this.$wrapper.find('.js-item-title').on(
                        'click',
                        this.handleTitleClick
                    );

                    this.$wrapper.find('.js-costs').on(
                        'click',
                        this.handleCostsClick
                    );

                    this.$wrapper.find('.js-payment-status-item').on(
                        'click',
                        this.handlePaymentStatusChange
                    );

                    this.$wrapper.find('.js-document-wrapper').on(
                        'click',
                        '.js-remove-document',
                        this.handleFormDocumentRemove
                    );

                    this.$wrapper.find('.js-document-add').on(
                        'click',
                        this.handleFormDocumentAdd
                    )
                },

                handleMenuItemClick: function () {
                    $(this).next('div').slideToggle();
                    $(this).parent().siblings().children().next().slideUp();
                },

                handleFormMenuItemClick: function () {
                    $(this).next().find('.js-form-item').slideToggle();
                },

                handleRowTitleClick: function () {
                    var $next = $(this).next();
                    $next.slideToggle();
                    $next.find('.js-item-card-title').click();
                },

                handleFormSubmit: function (e) {
                    e.preventDefault();

                    $.ajax({
                        url: $(this).closest('div').data('url'),
                        data: new FormData($(this)[0]),
                        method: 'POST',
                        processData: false,
                        contentType: false,
                        cache: false,
                        success: function (response) {
                            addNewApp.handleFormSuccess({
                                'form': $(this).serializeArray(),
                                'data': response
                            })
                        }
                    })
                },

                handleCardTitleClick: function() {
                    $(this).next().slideToggle();
                },

                handleTitleClick: function() {
                    $(this).next().next().slideToggle();
                },

                handleCostsClick: function () {
                    var self = $(this);
                    var costs = self.text().match(/\d+/)[0];
                    var currency = self.data('currency');

                    if (currency === 'EUR') {
                        $.ajax({
                            url: 'http://api.fixer.io/latest?symbols=IDR',
                            success: function (data) {
                                self.text('IDR ' + (costs * data.rates.IDR).toLocaleString());
                                self.data('currency', costs);
                            }
                        })
                    } else {
                        self.text('€ ' + (self.data('currency').toLocaleString()));
                        self.data('currency', 'EUR');
                    }
                },

                handlePaymentStatusChange: function(e) {
                    e.preventDefault();

                    var $dropDownMenu = $(this).closest('div');
                    var paymentStatus = $(this).text();

                    $.ajax({
                        url: '/api/payment-status',
                        data: {
                            'entity': $dropDownMenu.data('entity'),
                            'id':     $dropDownMenu.data('id'),
                            'paymentStatus': paymentStatus
                        },
                        method: 'POST',
                        success: function () {
                            $dropDownMenu.prev().text(paymentStatus);
                        }
                    })
                },

                handleFormDocumentRemove: function(e) {
                    e.preventDefault();
                    $(this).closest('.js-document-item').remove();
                },

                handleFormDocumentAdd: function (e) {
                    e.preventDefault();

                    var $documentWrapper = $(this).closest('.js-document-wrapper');
                    var prototype = $documentWrapper.data('prototype');
                    var index = $documentWrapper.data('index');
                    var newForm = prototype.replace(/__name__/g, index);
                    $documentWrapper.data('index', index + 1);
                    $(this).before(newForm);

                }

            };

            var addNewApp = {

                handleFormSuccess: function(data) {
                    switch (data.data.form) {
                        case 'transport':
                            this.transport(data);
                            break;
                        case 'hotel':
                            this.hotel(data);
                            break;
                        case 'attraction':
                            this.attraction(data);
                            break;
                        case 'prepayment':
                            this.prepayment(data);
                            break;
                        case 'document':
                            this.document(data);
                            break;
                    }
                },

                transport: function (data) {
                    console.log(data);
                },

                hotel: function (data) {

                },

                attraction: function (data) {

                },

                prepayment: function (data) {

                },

                document: function (data) {

                }
            };

            $(document).ready(function() {
                var $menu = $('.js-menu');
                EuropeTravelsApp.initialize($menu);
            });
        </script>
    {% endblock %}